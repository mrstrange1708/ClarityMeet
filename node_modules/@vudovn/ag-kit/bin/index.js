#!/usr/bin/env node

import { Command } from 'commander';
import chalk from 'chalk';
import ora from 'ora';
import { downloadTemplate } from 'giget';
import path from 'path';
import fs from 'fs';
import readline from 'readline';
import { fileURLToPath } from 'url';

// Get package.json for version
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const pkg = JSON.parse(fs.readFileSync(path.join(__dirname, '..', 'package.json'), 'utf-8'));

// ============================================================================
// CONSTANTS
// ============================================================================

const REPO = 'github:vudovn/antigravity-kit';
const AGENT_FOLDER = '.agent';
const TEMP_FOLDER = '.temp_ag_kit';

// ============================================================================
// UTILITIES
// ============================================================================

/**
 * Display ASCII banner
 * @param {boolean} quiet - Skip banner if true
 */
const showBanner = (quiet = false) => {
    if (quiet) return;
    console.log(chalk.blueBright(`
    ╔══════════════════════════════════════╗
    ║        ANTIGRAVITY KIT CLI           ║
    ╚══════════════════════════════════════╝
    `));
};

/**
 * Log message if not in quiet mode
 * @param {string} message - Message to log
 * @param {boolean} quiet - Skip logging if true
 */
const log = (message, quiet = false) => {
    if (!quiet) console.log(message);
};

/**
 * Ask user for confirmation
 * @param {string} question - Question to ask
 * @returns {Promise<boolean>}
 */
const confirm = (question) => {
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout,
    });

    return new Promise((resolve) => {
        rl.question(chalk.yellow(`${question} (y/N): `), (answer) => {
            rl.close();
            resolve(answer.toLowerCase() === 'y' || answer.toLowerCase() === 'yes');
        });
    });
};

/**
 * Clean up temporary directory
 * @param {string} tempDir - Temp directory path
 */
const cleanup = (tempDir) => {
    if (fs.existsSync(tempDir)) {
        fs.rmSync(tempDir, { recursive: true, force: true });
    }
};

/**
 * Copy .agent folder from temp to destination
 * @param {string} tempDir - Temp directory
 * @param {string} destDir - Destination directory
 */
const copyAgentFolder = (tempDir, destDir) => {
    const sourceAgent = path.join(tempDir, AGENT_FOLDER);

    if (!fs.existsSync(sourceAgent)) {
        throw new Error(`Could not find ${AGENT_FOLDER} folder in source repository!`);
    }

    fs.cpSync(sourceAgent, destDir, { recursive: true });
};


// ============================================================================
// COMMANDS
// ============================================================================

/**
 * Initialize .agent folder in project
 */
const initCommand = async (options) => {
    const quiet = options.quiet || false;
    const dryRun = options.dryRun || false;

    showBanner(quiet);

    const targetDir = path.resolve(options.path || process.cwd());
    const tempDir = path.join(targetDir, TEMP_FOLDER);
    const agentDir = path.join(targetDir, AGENT_FOLDER);

    // Dry run mode - show what would be done
    if (dryRun) {
        console.log(chalk.blueBright('\n[Dry Run] No changes will be made\n'));
        console.log(chalk.white('Would perform the following actions:'));
        console.log(chalk.gray('────────────────────────────────────────'));
        console.log(`  1. Download from: ${chalk.cyan(REPO)}${options.branch ? `#${options.branch}` : ''}`);
        console.log(`  2. Install to: ${chalk.cyan(agentDir)}`);
        if (fs.existsSync(agentDir)) {
            console.log(`  3. ${chalk.yellow('Overwrite existing .agent folder')}`);
        }
        console.log(chalk.gray('────────────────────────────────────────\n'));
        return;
    }

    // Check if .agent already exists
    if (fs.existsSync(agentDir)) {
        if (!options.force) {
            log(chalk.yellow(`Warning: Folder ${AGENT_FOLDER} already exists at: ${agentDir}`), quiet);
            const shouldOverwrite = await confirm('Do you want to overwrite it?');

            if (!shouldOverwrite) {
                log(chalk.gray('Operation cancelled.'), quiet);
                process.exit(0);
            }
        }
        log(chalk.gray(`Overwriting ${AGENT_FOLDER} folder...`), quiet);
    }

    const spinner = quiet ? null : ora({
        text: 'Downloading...',
        color: 'cyan',
    }).start();

    try {
        // Download repository using giget
        const repoSource = options.branch ? `${REPO}#${options.branch}` : REPO;
        await downloadTemplate(repoSource, {
            dir: tempDir,
            force: true,
        });

        if (spinner) spinner.text = 'Installing...';

        // Delete old .agent folder if exists (always clean install)
        if (fs.existsSync(agentDir)) {
            fs.rmSync(agentDir, { recursive: true, force: true });
        }

        // Copy .agent folder
        copyAgentFolder(tempDir, agentDir);


        // Cleanup
        cleanup(tempDir);

        if (spinner) {
            spinner.succeed(chalk.green('Installation successful!'));
        }

        // Success message
        if (!quiet) {
            console.log(chalk.gray('\n────────────────────────────────────────'));
            console.log(chalk.white('Result:'));
            console.log(`   ${chalk.cyan(AGENT_FOLDER)} → ${chalk.gray(agentDir)}`);
            console.log(chalk.gray('────────────────────────────────────────'));
            console.log(chalk.green('\nHappy coding!\n'));
        }
    } catch (error) {
        if (spinner) {
            spinner.fail(chalk.red(`Error: ${error.message}`));
        } else {
            console.error(chalk.red(`Error: ${error.message}`));
        }
        cleanup(tempDir);
        process.exit(1);
    }
};

/**
 * Update existing .agent folder
 */
const updateCommand = async (options) => {
    const quiet = options.quiet || false;

    showBanner(quiet);

    const targetDir = path.resolve(options.path || process.cwd());
    const agentDir = path.join(targetDir, AGENT_FOLDER);

    // Check if .agent exists
    if (!fs.existsSync(agentDir)) {
        console.log(chalk.red(`Error: Could not find ${AGENT_FOLDER} folder at: ${targetDir}`));
        console.log(chalk.yellow(`Tip: Run ${chalk.cyan('ag-kit init')} to install first.`));
        process.exit(1);
    }

    if (!options.force && !quiet) {
        log(chalk.yellow(`Warning: Update will overwrite the entire ${AGENT_FOLDER} folder`), quiet);
        const shouldUpdate = await confirm('Are you sure you want to continue?');

        if (!shouldUpdate) {
            log(chalk.gray('Operation cancelled.'), quiet);
            process.exit(0);
        }
    }

    // Call init with force option
    await initCommand({ ...options, force: true });
};

/**
 * Show status of .agent folder
 */
const statusCommand = (options) => {
    const targetDir = path.resolve(options.path || process.cwd());
    const agentDir = path.join(targetDir, AGENT_FOLDER);

    console.log(chalk.blueBright('\nAntigravity Kit Status\n'));

    if (fs.existsSync(agentDir)) {
        const stats = fs.statSync(agentDir);
        const files = fs.readdirSync(agentDir, { recursive: true });

        console.log(chalk.green('[OK] Installed'));
        console.log(chalk.gray('────────────────────────────────────────'));
        console.log(`Path:     ${chalk.cyan(agentDir)}`);
        console.log(`Modified: ${chalk.gray(stats.mtime.toLocaleString('en-US'))}`);
        console.log(`Files:    ${chalk.yellow(files.length)} items`);
        console.log(chalk.gray('────────────────────────────────────────\n'));
    } else {
        console.log(chalk.red('[X] Not installed'));
        console.log(chalk.yellow(`Run ${chalk.cyan('ag-kit init')} to install.\n`));
    }
};

// ============================================================================
// CLI DEFINITION
// ============================================================================

const program = new Command();

program
    .name('ag-kit')
    .description('CLI tool to install and manage Antigravity Kit')
    .version(pkg.version, '-v, --version', 'Display version number');

// Command: init
program
    .command('init')
    .description('Install .agent folder into your project')
    .option('-f, --force', 'Overwrite if folder already exists', false)
    .option('-p, --path <dir>', 'Path to the project directory', process.cwd())
    .option('-b, --branch <name>', 'Select repository branch')
    .option('-q, --quiet', 'Suppress output (for CI/CD)', false)
    .option('--dry-run', 'Show what would be done without executing', false)
    .action(initCommand);

// Command: update
program
    .command('update')
    .description('Update .agent folder to the latest version')
    .option('-f, --force', 'Skip confirmation prompt', false)
    .option('-p, --path <dir>', 'Path to the project directory', process.cwd())
    .option('-b, --branch <name>', 'Select repository branch')
    .option('-q, --quiet', 'Suppress output (for CI/CD)', false)
    .option('--dry-run', 'Show what would be done without executing', false)
    .action(updateCommand);

// Command: status
program
    .command('status')
    .description('Check installation status')
    .option('-p, --path <dir>', 'Path to the project directory', process.cwd())
    .action(statusCommand);

// Parse arguments
program.parse(process.argv);

// Show help if no command provided
if (!process.argv.slice(2).length) {
    program.outputHelp();
}
